<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LUXE Money 2025 - Bug Fixed</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1; --income: #10b981; --expense: #f43f5e;
            --bg: #0b0f1a; --card: rgba(23, 27, 44, 0.9);
            --glass: rgba(255, 255, 255, 0.05); --text: #ffffff; --sub: #94a3b8;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: 'Noto Sans Lao', sans-serif;
            background-color: var(--bg);
            background-image: radial-gradient(circle at 0% 0%, #1e1b4b 0%, transparent 50%),
                              radial-gradient(circle at 100% 100%, #312e81 0%, transparent 50%);
            color: var(--text); margin: 0; padding: 0;
            height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- PIN SCREEN (STABLE) --- */
        #pin-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding-bottom: 50px;
        }
        .pin-dots { display: flex; gap: 20px; margin-bottom: 40px; }
        .pin-dot { width: 14px; height: 14px; border: 2px solid var(--primary); border-radius: 50%; transition: 0.2s; }
        .pin-dot.active { background: var(--primary); box-shadow: 0 0 15px var(--primary); transform: scale(1.2); }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; width: 80%; max-width: 320px; }
        .num-btn { 
            aspect-ratio: 1/1; border-radius: 50%; background: var(--glass);
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
            font-weight: 600; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); color: white;
        }
        .num-btn:active { background: var(--primary); }

        /* --- LAYOUT STRUCTURE --- */
        .app-container { flex: 1; overflow-y: auto; padding: 20px 20px 100px; width: 100%; max-width: 500px; margin: auto; }

        /* --- MODERN BENTO HEADER --- */
        .dashboard-header {
            background: var(--card); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 30px; padding: 25px; margin-bottom: 20px; text-align: center;
            backdrop-filter: blur(10px);
        }
        .balance-title { font-size: 0.75rem; color: var(--sub); letter-spacing: 2px; font-weight: 700; margin-bottom: 5px; }
        .balance-main { font-size: 2.2rem; font-weight: 700; margin-bottom: 20px; }
        .mini-wallets { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .mw-item { background: var(--glass); padding: 12px; border-radius: 20px; font-size: 0.8rem; border: 1px solid rgba(255,255,255,0.05); }

        /* --- GLASS CARDS --- */
        .glass-card { background: var(--card); border-radius: 24px; padding: 20px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .card-header { font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; }

        /* --- INPUT ELEMENTS --- */
        .type-pill { display: flex; background: #000; padding: 5px; border-radius: 15px; margin-bottom: 15px; }
        .tp-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; background: transparent; color: var(--sub); font-weight: 700; font-family: inherit; font-size: 0.9rem; }
        .tp-btn.active-exp { background: var(--expense); color: white; }
        .tp-btn.active-inc { background: var(--income); color: white; }

        input, select { 
            width: 100%; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1);
            padding: 14px; border-radius: 15px; color: white; margin-bottom: 12px;
            font-size: 16px; font-family: inherit; -webkit-appearance: none;
        }
        .btn-action { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 18px; font-weight: 700; font-size: 1rem; box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3); }

        /* --- REPORT CHART --- */
        .cat-row { margin-bottom: 15px; }
        .bar-wrap { width: 100%; background: rgba(255,255,255,0.05); height: 10px; border-radius: 5px; margin-top: 6px; overflow: hidden; }
        .bar-inner { background: var(--primary); height: 100%; width: 0%; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }

        /* --- TRANSACTION ITEMS --- */
        .tx-card { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--glass); border-radius: 20px; margin-bottom: 10px; }
        .tx-info b { display: block; font-size: 0.9rem; margin-bottom: 2px; }
        .tx-info small { color: var(--sub); font-size: 0.7rem; }

        /* --- BOTTOM NAV (STABLE) --- */
        .bottom-nav { 
            position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%);
            width: calc(100% - 40px); max-width: 460px;
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px);
            border-radius: 25px; display: flex; justify-content: space-around;
            padding: 12px 0; border: 1px solid rgba(255,255,255,0.1); z-index: 1000;
        }
        .nav-link { border: none; background: none; color: var(--sub); display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.65rem; font-weight: 600; cursor: pointer; }
        .nav-link.active { color: var(--primary); }

        .view { display: none; height: 100%; }
        .view.active { display: block; animation: fadeInUp 0.4s ease; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #share-preview { width: 100%; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 15px; display: block; }
        #canvas-hidden { display: none; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="pin-screen">
    <i class="fa-solid fa-lock-gradient fa-shield-halved" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
    <h3 id="pin-msg">ໃສ່ລະຫັດ PIN</h3>
    <div class="pin-dots">
        <div class="pin-dot" id="dot-0"></div><div class="pin-dot" id="dot-1"></div>
        <div class="pin-dot" id="dot-2"></div><div class="pin-dot" id="dot-3"></div>
    </div>
    <div class="numpad">
        <div class="num-btn" onclick="tap(1)">1</div><div class="num-btn" onclick="tap(2)">2</div><div class="num-btn" onclick="tap(3)">3</div>
        <div class="num-btn" onclick="tap(4)">4</div><div class="num-btn" onclick="tap(5)">5</div><div class="num-btn" onclick="tap(6)">6</div>
        <div class="num-btn" onclick="tap(7)">7</div><div class="num-btn" onclick="tap(8)">8</div><div class="num-btn" onclick="tap(9)">9</div>
        <div class="num-btn" onclick="tap('C')"><i class="fa-solid fa-backspace"></i></div>
        <div class="num-btn" onclick="tap(0)">0</div>
        <div class="num-btn" onclick="location.reload()"><i class="fa-solid fa-refresh"></i></div>
    </div>
</div>

<div class="app-container">
    <div class="dashboard-header">
        <div class="balance-title">ເງິນຄົງເຫຼືອທັງໝົດ</div>
        <div class="balance-main" id="sum-total">0 ₭</div>
        <div class="mini-wallets">
            <div class="mw-item"><i class="fa-solid fa-coins" style="color:var(--primary)"></i> ສົດ: <b id="sum-cash">0</b></div>
            <div class="mw-item"><i class="fa-solid fa-bank" style="color:var(--primary)"></i> ແບັງ: <b id="sum-bank">0</b></div>
        </div>
    </div>

    <div id="v-add" class="view active">
        <div class="glass-card">
            <div class="type-pill">
                <button id="m-exp" class="tp-btn active-exp" onclick="setMode('expense')">ລາຍຈ່າຍ</button>
                <button id="m-inc" class="tp-btn" onclick="setMode('income')">ລາຍຮັບ</button>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input type="date" id="in-date">
                <select id="in-wallet"><option value="Cash">Cash (ສົດ)</option><option value="Bank">Bank (ແບັງ)</option></select>
            </div>
            <select id="in-cat"></select>
            <input type="text" id="in-amt" inputmode="decimal" placeholder="0 ₭" oninput="fNumber(this)" style="text-align:center; font-size:1.5rem; color:var(--primary); font-weight:700;">
            <input type="text" id="in-note" placeholder="ໝາຍເຫດ (ຊື້ຫຍັງ?)...">
            <button class="btn-action" onclick="save()">ບັນທຶກລາຍການ</button>
        </div>
        <div id="feed-list"></div>
    </div>

    <div id="v-report" class="view">
        <div class="glass-card">
            <div class="card-header"><i class="fa-solid fa-chart-pie"></i> ລາຍຈ່າຍແຍກໝວດໝູ່ (ເດືອນນີ້)</div>
            <div id="cat-bars-render"></div>
        </div>
    </div>

    <div id="v-share" class="view">
        <div class="glass-card" style="text-align:center;">
            <div class="card-header"><i class="fa-solid fa-share-nodes"></i> ສ້າງສະຫຼຸບໃຫ້ຄອບຄົວ</div>
            <canvas id="canvas-hidden" width="600" height="850"></canvas>
            <img id="share-preview" alt="Finance Summary">
            <button class="btn-action" onclick="downloadImg()" style="background:var(--income);"><i class="fa-solid fa-download"></i> Save as Image</button>
        </div>
    </div>

    <div id="v-settings" class="view">
        <div class="glass-card">
            <div class="card-header">ຈັດການໝວດໝູ່</div>
            <div style="display: flex; gap: 8px;">
                <input type="text" id="n-cat" placeholder="ຊື່ໝວດໝູ່ໃໝ່..." style="margin:0;">
                <button onclick="addC()" style="width:60px; border-radius:15px; border:none; background:var(--primary); color:white;"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div id="cat-list-settings" style="margin-top:20px;"></div>
        </div>
        <div class="glass-card">
            <button class="btn-action" style="background:#334155; margin-bottom:12px;" onclick="exportData()"><i class="fa-solid fa-file-export"></i> Backup ຂໍ້ມູນ</button>
            <button class="btn-action" style="background:var(--expense);" onclick="resetPIN()"><i class="fa-solid fa-key"></i> ປ່ຽນລະຫັດ PIN</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <button class="nav-link active" onclick="nav('add', this)"><i class="fa-solid fa-house"></i><span>ໜ້າຫຼັກ</span></button>
        <button class="nav-link" onclick="nav('report', this)"><i class="fa-solid fa-chart-simple"></i><span>ລາຍງານ</span></button>
        <button class="nav-link" onclick="nav('share', this)"><i class="fa-solid fa-image"></i><span>Share</span></button>
        <button class="nav-link" onclick="nav('settings', this)"><i class="fa-solid fa-sliders"></i><span>ຕັ້ງຄ່າ</span></button>
    </nav>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('money_pro_stable_v3')) || {
        records: [], cats: ['ອາຫານ', 'ນ້ຳມັນ', 'ເງິນເດືອນ', 'ຄ່າຫ້ອງ', 'ທົ່ວໄປ'], pin: null, m: 'expense'
    };

    let pInput = "";
    document.getElementById('in-date').valueAsDate = new Date();

    // PIN SYSTEM (TOUCH FRIENDLY)
    function tap(n) {
        if(n==='C') pInput = ""; else if(pInput.length < 4) pInput += n;
        for(let i=0; i<4; i++) document.getElementById('dot-'+i).className = i < pInput.length ? "pin-dot active" : "pin-dot";
        if(pInput.length === 4) {
            setTimeout(() => {
                if(!db.pin) { db.pin = pInput; saveDB(); document.getElementById('pin-screen').style.display='none'; }
                else if(pInput === db.pin) document.getElementById('pin-screen').style.display='none';
                else { alert("ລະຫັດຜິດ!"); pInput=""; tap('C'); }
            }, 200);
        }
    }

    function nav(v, el) {
        document.querySelectorAll('.view').forEach(x => x.classList.remove('active'));
        document.getElementById('v-'+v).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(x => x.classList.remove('active'));
        el.classList.add('active');
        if(v==='report') renderReport();
        if(v==='share') genImage();
        if(v==='settings') renderSettings();
    }

    function fNumber(el) {
        let v = el.value.replace(/,/g, '');
        if(!isNaN(v) && v!=="") el.value = Number(v).toLocaleString();
    }

    function setMode(m) {
        db.m = m;
        document.getElementById('m-exp').className = m==='expense' ? 'tp-btn active-exp' : 'tp-btn';
        document.getElementById('m-inc').className = m==='income' ? 'tp-btn active-inc' : 'tp-btn';
    }

    function saveDB() { localStorage.setItem('money_pro_stable_v3', JSON.stringify(db)); render(); }

    function save() {
        const amtStr = document.getElementById('in-amt').value.replace(/,/g, '');
        const amt = parseFloat(amtStr);
        if(!amt || amt <= 0) return alert("ປ້ອນຈຳນວນເງິນກ່ອນ!");
        
        db.records.unshift({ id: Date.now(), type: db.m, amt, note: document.getElementById('in-note').value, cat: document.getElementById('in-cat').value, date: document.getElementById('in-date').value, wallet: document.getElementById('in-wallet').value });
        document.getElementById('in-amt').value = ""; document.getElementById('in-note').value = "";
        saveDB(); alert("ບັນທຶກແລ້ວ!");
    }

    function render() {
        let t = 0, c = 0, b = 0;
        db.records.forEach(r => {
            let v = r.type==='income' ? r.amt : -r.amt;
            t += v; if(r.wallet==='Cash') c += v; else b += v;
        });
        document.getElementById('sum-total').innerText = t.toLocaleString() + " ₭";
        document.getElementById('sum-cash').innerText = c.toLocaleString();
        document.getElementById('sum-bank').innerText = b.toLocaleString();
        document.getElementById('in-cat').innerHTML = db.cats.map(x => `<option value="${x}">${x}</option>`).join('');
        
        document.getElementById('feed-list').innerHTML = db.records.map(r => `
            <div class="tx-card">
                <div style="display:flex; align-items:center;">
                    <div style="width:42px; height:42px; border-radius:12px; background:rgba(255,255,255,0.05); display:flex; align-items:center; justify-content:center; color:var(--${r.type})">
                        <i class="fa-solid ${r.type==='income'?'fa-arrow-trend-up':'fa-arrow-trend-down'}"></i>
                    </div>
                    <div style="margin-left:15px;" class="tx-info"><b>${r.note || r.cat}</b><small>${r.date} • ${r.cat}</small></div>
                </div>
                <div style="text-align:right">
                    <b style="color:var(--${r.type})">${r.type==='income'?'+':'-'}${r.amt.toLocaleString()}</b>
                    <div onclick="delR(${r.id})" style="color:var(--sub); font-size:0.7rem; margin-top:5px;"><i class="fa-solid fa-trash-can"></i></div>
                </div>
            </div>`).join('') || '<p style="text-align:center; color:var(--sub); font-size:0.8rem; margin-top:20px;">ຍັງບໍ່ມີຂໍ້ມູນ</p>';
    }

    function renderReport() {
        const curM = new Date().toISOString().substring(0, 7);
        const cm = {};
        db.records.filter(r => r.type === 'expense' && r.date.startsWith(curM)).forEach(r => cm[r.cat] = (cm[r.cat] || 0) + r.amt);
        const sorted = Object.entries(cm).sort((a,b)=>b[1]-a[1]);
        const max = Math.max(...Object.values(cm), 1);
        document.getElementById('cat-bars-render').innerHTML = sorted.map(([k,v]) => `
            <div class="cat-row">
                <div style="display:flex; justify-content:space-between; font-size:0.8rem;"><span>${k}</span><b>${v.toLocaleString()} ₭</b></div>
                <div class="bar-wrap"><div class="bar-inner" style="width:${(v/max)*100}%"></div></div>
            </div>`).join('') || '<div style="text-align:center; color:var(--sub);">ບໍ່ມີຂໍ້ມູນເດືອນນີ້</div>';
    }

    function renderSettings() {
        document.getElementById('cat-list-settings').innerHTML = db.cats.map(c => `
            <div style="display:flex; justify-content:space-between; padding:12px; background:var(--glass); border-radius:15px; margin-bottom:8px; font-size:0.9rem;">
                <span>${c}</span><span style="color:var(--expense);" onclick="delC('${c}')"><i class="fa-solid fa-circle-xmark"></i></span>
            </div>`).join('');
    }

    function genImage() {
        const canvas = document.getElementById('canvas-hidden');
        const ctx = canvas.getContext('2d');
        const curM = new Date().toISOString().substring(0, 7);
        let inc = 0, exp = 0;
        const cm = {};
        db.records.filter(r => r.date.startsWith(curM)).forEach(r => {
            if(r.type==='income') inc += r.amt; else { exp += r.amt; cm[r.cat] = (cm[r.cat] || 0) + r.amt; }
        });

        // DRAWING PREMIUM CARD
        ctx.fillStyle = "#0b0f1a"; ctx.fillRect(0, 0, 600, 850);
        ctx.fillStyle = "#6366f1"; ctx.fillRect(0, 0, 600, 180);
        ctx.fillStyle = "#ffffff"; ctx.font = "bold 40px Arial"; ctx.fillText("Monthly Report", 50, 80);
        ctx.font = "24px Arial"; ctx.fillText(`Month: ${curM}`, 50, 130);

        ctx.fillStyle = "#171b2c"; ctx.fillRect(40, 220, 520, 180);
        ctx.fillStyle = "#ffffff"; ctx.font = "24px Arial"; ctx.fillText("Total Income:", 70, 280);
        ctx.fillStyle = "#10b981"; ctx.fillText(`+ ${inc.toLocaleString()} KIP`, 320, 280);
        ctx.fillStyle = "#ffffff"; ctx.fillText("Total Expense:", 70, 340);
        ctx.fillStyle = "#f43f5e"; ctx.fillText(`- ${exp.toLocaleString()} KIP`, 320, 340);

        ctx.fillStyle = "#ffffff"; ctx.font = "bold 28px Arial"; ctx.fillText("Top Spending:", 50, 460);
        let y = 520;
        Object.entries(cm).sort((a,b)=>b[1]-a[1]).slice(0, 5).forEach(([cat, amt]) => {
            ctx.fillStyle = "rgba(255,255,255,0.6)"; ctx.font = "22px Arial"; ctx.fillText(cat, 70, y);
            ctx.fillStyle = "#ffffff"; ctx.fillText(`${amt.toLocaleString()} KIP`, 380, y);
            y += 50;
        });
        document.getElementById('share-preview').src = canvas.toDataURL();
    }

    function downloadImg() { const a = document.createElement('a'); a.download = 'report.png'; a.href = document.getElementById('canvas-hidden').toDataURL(); a.click(); }
    function delR(id) { if(confirm("⚠️ ລຶບລາຍການນີ້?")) { db.records = db.records.filter(r => r.id !== id); saveDB(); } }
    function delC(n) { if(confirm(`⚠️ ລຶບໝວດໝູ່ "${n}"?`)) { db.cats = db.cats.filter(x => x !== n); saveDB(); renderSettings(); } }
    function addC() { const n = document.getElementById('n-cat').value.trim(); if(n && !db.cats.includes(n)) { db.cats.push(n); document.getElementById('n-cat').value=""; saveDB(); renderSettings(); } }
    function exportData() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(db)], {type:'application/json'})); a.download="money_backup.json"; a.click(); }
    function resetPIN() { if(confirm("Reset PIN?")) { db.pin = null; saveDB(); location.reload(); } }

    if(db.pin) document.getElementById('pin-msg').innerText = "ໃສ່ PIN 4 ໂຕ";
    render();
</script>
</body>
</html>
